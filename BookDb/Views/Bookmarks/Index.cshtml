@model IEnumerable<BookDb.Models.Bookmark>

@{
    ViewData["Title"] = "Danh s치ch Bookmark";
}

<link rel="stylesheet" href="~/css/bookmark-signalr.css" />

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Danh s치ch Bookmark</h2>
    <div class="signalr-status-inline">
        <span class="realtime-indicator" id="realtimeIndicator"></span>
        <small class="text-muted">Real-time</small>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-8">
        <button type="button" class="btn btn-info" id="refreshBookmarks">
            <span id="refreshSpinner" class="spinner-border spinner-border-sm d-none"></span>
            L맔 m敲뜰
        </button>
        <a href="@Url.Action("TestSignalR", "Bookmarks")" class="btn btn-outline-secondary">
            游댢 Test SignalR
        </a>
    </div>
    <div class="col-md-4">
        <form method="get" asp-action="Index" id="searchForm">
            <div class="input-group">
                <input type="text" name="q" id="searchQuery" class="form-control"
                       placeholder="T칣m theo t칡n t말 li敲u..."
                       value="@Context.Request.Query["q"]" />
                <button type="submit" class="btn btn-info">T칣m</button>
            </div>
        </form>
    </div>
</div>

<div id="bookmarksContainer">
    @if (!Model.Any())
    {
        <div class="alert alert-info">
            Ch퀋a c칩 bookmark n맖. H칚y th칡m bookmark khi xem t말 li敲u!
        </div>
    }
    else
    {
        <table class="table table-bordered table-striped bookmark-table">
            <thead>
                <tr>
                    <th>T말 li敲u</th>
                    <th>Trang</th>
                    <th>Ghi ch칰</th>
                    <th>Ng맟 t故멾</th>
                    <th style="width: 200px;">Thao t치c</th>
                </tr>
            </thead>
            <tbody id="bookmarksList">
                @foreach (var item in Model)
                {
                    <tr data-bookmark-id="@item.Id">
                        <td>@item.DocumentPage?.Document?.Title</td>
                        <td class="text-center">@item.DocumentPage?.PageNumber</td>
                        <td>@item.Title</td>
                        <td>@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>
                            <a asp-controller="Documents" asp-action="ViewDocument"
                               asp-route-id="@item.DocumentPage?.DocumentId"
                               asp-route-mode="paged"
                               asp-route-page="@item.DocumentPage?.PageNumber"
                               class="btn btn-sm btn-success">Xem</a>

                            <button type="button" class="btn btn-sm btn-danger delete-bookmark-btn"
                                    data-id="@item.Id"
                                    data-title="@item.Title">
                                X칩a
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<!-- Modal for Bookmark Details -->
<div class="modal fade" id="bookmarkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti故쯦 Bookmark</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookmarkModalBody">
                <!-- Content loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">캟칩ng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/bookmark-signalr.js"></script>
    <script>
        $(document).ready(function () {
            // Ajax search with debounce
            let searchTimeout;
            $('#searchQuery').on('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function () {
                    performSearch();
                }, 500);
            });

            function performSearch() {
                const query = $('#searchQuery').val();
                loadBookmarks(query);
            }

            // Refresh bookmarks
            $('#refreshBookmarks').on('click', function () {
                const query = $('#searchQuery').val();
                loadBookmarks(query);
            });

            function loadBookmarks(query = '') {
                $.ajax({
                    url: '@Url.Action("Index", "Bookmarks")',
                    type: 'GET',
                    data: { q: query },
                    beforeSend: function () {
                        $('#refreshSpinner').removeClass('d-none');
                    },
                    success: function (response) {
                        const $html = $(response);
                        const newContent = $html.find('#bookmarksList').html();

                        if (newContent) {
                            $('#bookmarksList').html(newContent);
                            window.NotificationHub.showLocal('캟칚 c故셣 nh故셦 danh s치ch', 'success');
                        } else {
                            $('#bookmarksContainer').html('<div class="alert alert-info">Kh칪ng t칣m th故볓 bookmark n맖</div>');
                        }
                    },
                    error: function () {
                        window.NotificationHub.showLocal('C칩 l敲들 khi t故믈 danh s치ch', 'error');
                    },
                    complete: function () {
                        $('#refreshSpinner').addClass('d-none');
                    }
                });
            }

            // Delete bookmark with Ajax
            $(document).on('click', '.delete-bookmark-btn', function () {
                const bookmarkId = $(this).data('id');
                const title = $(this).data('title') || 'bookmark n맟';
                const $row = $(this).closest('tr');

                if (!confirm(`B故멽 c칩 ch故슦 mu敲녍 x칩a "${title}"?`)) {
                    return;
                }

                $.ajax({
                    url: '@Url.Action("Delete", "Bookmarks")/' + bookmarkId,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    beforeSend: function () {
                        $row.css('opacity', '0.5');
                    },
                    success: function () {
                        $row.fadeOut(300, function () {
                            $(this).remove();

                            // Check if no more bookmarks
                            if ($('#bookmarksList tr').length === 0) {
                                $('#bookmarksContainer').html('<div class="alert alert-info">Ch퀋a c칩 bookmark n맖</div>');
                            }
                        });

                        window.NotificationHub.showLocal('캟칚 x칩a bookmark', 'success');
                    },
                    error: function (xhr) {
                        $row.css('opacity', '1');
                        let errorMsg = 'C칩 l敲들 khi x칩a bookmark';
                        if (xhr.status === 404) {
                            errorMsg = 'Kh칪ng t칣m th故볓 bookmark';
                        }
                        window.NotificationHub.showLocal(errorMsg, 'error');
                    }
                });
            });

            // Note: Bookmarks are personal, no SignalR broadcasting needed
            // Just local notifications when user creates/deletes their own bookmarks
            
            // Update connection indicator if NotificationHub is available
            if (window.NotificationHub && window.NotificationHub.connection) {
                const connection = window.NotificationHub.connection;
                
                function updateRealtimeIndicator() {
                    const indicator = $('#realtimeIndicator');
                    if (connection && connection.state === signalR.HubConnectionState.Connected) {
                        indicator.removeClass('disconnected');
                    } else {
                        indicator.addClass('disconnected');
                    }
                }

                setInterval(updateRealtimeIndicator, 2000);
                updateRealtimeIndicator();
            }
        });
    </script>
}

@* Anti-forgery token for AJAX *@
<form id="__AjaxAntiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>